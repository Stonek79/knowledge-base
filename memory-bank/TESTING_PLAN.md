# Детализированный План Тестирования

Этот документ описывает детализированную стратегию тестирования для обеспечения качества и стабильности приложения.

---

## Этап 0: Настройка Тестового Окружения

Это основа, без которой качественное тестирование невозможно.

1.  **Установка зависимостей:**
    *   `jest`, `ts-jest`, `@types/jest` - для запуска тестов.
    *   `@testing-library/react`, `@testing-library/jest-dom` - для тестирования React-компонентов.
    *   `prisma-mock` - для мокирования Prisma Client в unit-тестах.
    *   `supertest` - для тестирования API-роутов.
2.  **Конфигурация Jest (`jest.config.js`):**
    *   Настроить `preset: 'ts-jest'` для поддержки TypeScript.
    *   Настроить `testEnvironment: 'jsdom'` для эмуляции DOM.
    *   Настроить `moduleNameMapper` для корректной работы импортов Next.js (`@/lib/…`).
    *   Настроить `setupFilesAfterEnv: ['./jest.setup.js']` для глобальных настроек.
3.  **Настройка для Интеграционных тестов:**
    *   Создать отдельный сервис `postgres-test` в `docker-compose.yml`.
    *   Добавить скрипт в `package.json` для запуска интеграционных тестов с переменной `DATABASE_URL`, указывающей на тестовую БД.
4.  **Отчеты о Покрытии:**
    *   Настроить Jest для сбора и генерации отчетов о покрытии кода тестами (`--coverage`).
    *   Установить цель по покрытию в **80%** для критических модулей (сервисы, утилиты).

---

## Этап 1: Детализированные Unit-тесты (Фундамент)

Проверяем каждый модуль в изоляции.

1.  **`src/lib/utils/`**:
    *   `date.ts`: Проверить форматирование для валидных, невалидных и `null` дат.
    *   `files.ts`: Проверить `formatFileSize` для байтов, КБ, МБ и 0.
    *   `mime.ts`: Проверить `isSupportedMime` на всех поддерживаемых и неподдерживаемых типах.

2.  **`src/lib/services/` (Ключевая бизнес-логика):**
    *   **`AuthService`:**
        *   `login()`: Успех, неверный пароль (`ApiError 401`), пользователь не найден (`ApiError 404`), пользователь заблокирован (`enabled: false`), пользователь — "пустышка" (`status: PLACEHOLDER`).
    *   **`UserService`:**
        *   `findOrCreateAuthor()`: Находит существующего автора; создает нового с временным статусом, если не нашел.
        *   `changePassword()`: Успешная смена; ошибка при неверном старом пароле.
    *   **`DocumentCommandService`:**
        *   `createDocument()`: Проверить вызовы `FileStorageService.uploadDocument` и `prisma.document.create`. Проверить откат файла при ошибке в `prisma`.
        *   `updateDocument()`: Проверить права (админ vs. владелец).
        *   `softDeleteDocument()` / `hardDeleteDocument()`: Проверить, что `softDelete` устанавливает `deletedAt`, а `hardDelete` вызывает `prisma.document.delete` и доступен только админу.
    *   **`DocumentQueryService`:**
        *   `searchDocuments()`: Проверить правильность построения `where` для Prisma при разных фильтрах. Проверить логику доступа к конфиденциальным документам.

---

## Этап 2: Детализированные Integration-тесты (Взаимодействие)

Проверяем, как модули работают вместе, с фокусом на API.

1.  **`/api/users`:**
    *   `GET`: Запрос от админа (видит всех), от юзера (не видит админов), от гостя (ошибка 401/403). Проверить работу пагинации и поиска.
    *   `POST`: Попытка создания от юзера (403). Создание от админа (201). Создание с дубликатом `username` (409).
2.  **`/api/documents/{id}`:**
    *   `PUT`: Успешное обновление своего документа. Попытка обновления чужого (403). Обновление несуществующего (404).
    *   `DELETE`: Мягкое удаление (200). Попытка жесткого удаления (`?hard=true`) от юзера (403). Жесткое удаление от админа (200).
3.  **Загрузка файлов (`/api/documents`):**
    *   `POST`: Валидный файл (201). Невалидный MIME-тип (415). Слишком большой файл (413).

---

## Этап 3: Детализированные E2E-тесты (Полные сценарии)

Используем **Playwright** для симуляции действий реального пользователя.

1.  **Сквозной сценарий "Жизненный цикл пользователя и документа":**
    1.  Админ логинится, создает пользователя "TestUser".
    2.  "TestUser" логинится.
    3.  "TestUser" загружает документ с вложениями.
    4.  "TestUser" ищет и находит свой документ.
    5.  "TestUser" редактирует метаданные документа.
    6.  "TestUser" скачивает zip-архив с документом.
    7.  "TestUser" выполняет "мягкое" удаление документа.
    8.  Админ логинится.
    9.  Админ видит и восстанавливает "мягко" удаленный документ.
    10. Админ выполняет "жесткое" удаление документа.
    11. Админ удаляет пользователя "TestUser".

2.  **Сценарий поиска (детальный кейс):**
    -   Залогиниться.
    -   Перейти на страницу поиска.
    -   Ввести в поисковую строку `"Закон № 218-ФЗ"`.
    -   Убедиться, что в результатах есть нужный документ, и в сниппете подсвечены оба слова.