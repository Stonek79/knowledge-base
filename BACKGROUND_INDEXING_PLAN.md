# План: Внедрение фоновой индексации через Redis

**Цель:** Перенести ресурсоемкую операцию индексации в фоновый процесс, чтобы ускорить ответ API, повысить надежность системы и решить проблему транзакционности при создании/обновлении документов.

---

## Фаза 1: Создание инфраструктуры фоновых задач

### Шаг 1: Установка зависимостей

-   **Файл:** `package.json`
-   **Действие:** Добавить `bullmq` для управления очередями. `ioredis` уже есть в проекте.
-   **Команда:** `pnpm add bullmq`

### Шаг 2: Создание сервиса очереди

-   **Файл (новый):** `src/lib/queues/indexing.ts`
-   **Действие:** Создать и настроить экземпляры `Queue` из `bullmq`. Этот файл будет экспортировать синглтон очереди для добавления задач из API.

### Шаг 3: Создание фонового воркера

-   **Файл (новый):** `scripts/worker.ts`
-   **Действие:** Создать главный файл для воркер-процесса.
    -   **Логика:** Процесс будет подключаться к Redis, слушать очередь, забирать задачи и выполнять их (индексацию, удаление из индекса).
    -   **Обработка ошибок:** Настроить логирование и базовую стратегию повтора для упавших задач.

### Шаг 4: Интеграция воркера в проект

1.  **Добавить скрипт запуска:**
    -   **Файл:** `package.json`
    -   **Действие:** Добавить в секцию `"scripts"` новую команду: `"worker": "node --loader ts-node/esm scripts/worker.ts"`
    -   **Зависимость:** `pnpm add -D ts-node`

2.  **Добавить сервис в Docker:**
    -   **Файлы:** `docker-compose.yml`
    -   **Действие:** Добавить новый сервис `worker` по аналогии с сервисом `app`.

### Шаг 5: Рефакторинг API

-   **Цель:** Заменить все прямые вызовы `indexer` на добавление соответствующей задачи в очередь.
-   **Затрагиваемые эндпоинты:**
    -   `POST /api/documents` (создание): добавить задачу `index-document`.
    -   `POST /api/documents/[documentId]/compose/commit` (сложное редактирование): добавить задачу `index-document`.
    -   `PUT /api/documents/[documentId]` (редактирование метаданных): добавить задачу `index-document`.
    -   `DELETE /api/documents/[documentId]` (удаление): добавить задачу `remove-from-index`.

**Статус:** ✅ Завершено

---

## Фаза 2: Комплексное извлечение контента и переиндексация (В работе)

**Цель:** Гарантировать, что любое изменение файлового состава документа (замена основного файла, добавление/удаление приложений) инициирует полное переизвлечение текста из **всех** актуальных исходных файлов и последующую переиндексацию.

### Шаг 1 (Рефакторинг): Создание сервиса для извлечения текста

-   **Действие:** Создать новый, переиспользуемый сервис `TextExtractorService`.
-   **Файл (новый):** `src/core/documents/TextExtractorService.ts`
-   **Логика:** Перенести и инкапсулировать логику извлечения текста из `DocumentProcessor` и `scripts/worker.ts`. Сервис будет принимать буфер файла и MIME-тип, а возвращать извлеченный текст. Это позволит избежать дублирования кода и упростит тестирование.

### Шаг 2: Создание сервиса для обновления контента

-   **Действие:** Создать сервис `DocumentContentService`, который будет оркестрировать процесс обновления контента.
-   **Файл (новый):** `src/core/documents/DocumentContentService.ts`
-   **Логика:**
    1.  Получить `documentId`.
    2.  Используя Prisma, запросить из БД документ и все его вложения.
    3.  Используя `FileStorageService`, скачать все необходимые файлы из MinIO.
    4.  Для каждого файла вызвать `TextExtractorService` для извлечения текста.
    5.  Объединить весь полученный текст в одну строку.
    6.  Обновить поле `content` в таблице `Document` в базе данных.

### Шаг 3: Доработка воркера (`scripts/worker.ts`)

-   **Действие:** Упростить воркер, сделав его клиентом для `DocumentContentService`.
-   **Новое имя задачи:** `update-content-and-reindex`.
-   **Логика обработчика:**
    1.  Получить `documentId` из задачи.
    2.  Вызвать `documentContentService.updateContent(documentId)`.
    3.  По окончании поставить в очередь новую задачу `index-document` с тем же `documentId` для финальной индексации.

### Шаг 4: Доработка API (`compose/commit`)

-   **Файл:** `src/app/api/documents/[documentId]/compose/commit/route.ts`
-   **Действие:** Заменить постановку задачи `index-document` на `update-content-and-reindex`.
-   **Оптимизация:** Ставить задачу `update-content-and-reindex` только если в запросе были изменения файлового состава (`replaceMain`, `addAttachments`, `deleteAttachmentIds`). Если менялись только метаданные, можно по-прежнему ставить сразу более легкую задачу `index-document`.