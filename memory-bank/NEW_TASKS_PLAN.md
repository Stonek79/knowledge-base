# План реализации новых задач

Этот документ описывает пошаговый план для внедрения системы логирования, управления временными пользователями и рефакторинга удаления документов.

---

## Шаг 0: Единое обновление схемы БД

**Цель:** Сгруппировать все изменения в `prisma.schema` в один шаг, чтобы создать единую миграцию и избежать лишних миграций в будущем.

- **Файл:** `prisma/schema.prisma`
- **Действия:**
    1.  **Для системы аудита:** Добавить `enum ActionType` и модель `AuditLog`.
    2.  **Для "мягкого" удаления:** Добавить поле `deletedAt: DateTime?` в модель `Document`.
    3.  **Создать миграцию:** Выполнить команду `make migrate-dev` с осмысленным названием, например `add_audit_log_and_soft_delete`.

---

## 1. Задача: Внедрение системы аудита (Логирование действий)

**Цель:** Отслеживать и записывать все ключевые действия пользователей в системе с разделением прав доступа к логам.

*Предполагается, что Шаг 0 уже выполнен.*

### Шаг 1: Сервис аудита
- **Файл:** `src/lib/services/AuditService.ts` (новый файл)
- **Действия:**
    1.  Создать класс `AuditService` с одним статическим методом `log`.

### Шаг 2: Интеграция сервиса
- **Действия:** Импортировать и вызывать `AuditService.log()` в следующих местах:
    - **`src/lib/auth/AuthService.ts`**: В методе `login` после успешной аутентификации и при неудачной попытке.
    - **`src/lib/services/UserService.ts`**: В методах `createUser`, `updateUser`, `deleteUser`, `updateProfile` и при смене пароля.
    - **`src/lib/services/DocumentCommandService.ts`**: В методах `createDocument`, `updateDocument`, `softDeleteDocument` и `hardDeleteDocument`.
    - **`src/lib/services/DocumentQueryService.ts`**: В методе `getDocumentById` **добавить проверку**: если роль пользователя НЕ `ADMIN`, логировать действие `DOCUMENT_VIEWED`. При скачивании логировать `DOCUMENT_DOWNLOADED`.

### Шаг 3: UI для просмотра логов
- **Задача:** Создать страницу в админ-панели для просмотра логов, доступную **только админам**.
- **Файлы:**
    - `/src/app/api/admin/audit/route.ts` (новый)
    - `/src/app/admin/audit/page.tsx` (новый)
- **Действия:**
    1.  API-эндпоинт должен проверять роль запрашивающего пользователя. Если это не `ADMIN`, возвращать ошибку 403.
    2.  Реализовать страницу для отображения записей из `AuditLog` с пагинацией и фильтрацией. Администратор должен видеть все логи.

---

## 2. Задача: Управление временными пользователями (`PLACEHOLDER`)

**Статус:** ✅ **Выполнено.**

**Цель:** Дать администраторам возможность видеть "временных" пользователей и управлять ими.

### Шаг 1: API
- **Файл:** `/src/app/api/admin/users/route.ts`
- **Действия:**
    1.  Модифицировать `GET` обработчик, чтобы он принимал опциональный query-параметр `status`.
    2.  Если `status` передан, фильтровать пользователей по этому статусу.

### Шаг 2: UI
- **Файл:** `/src/components/users/UsersPage.tsx`
- **Действия:**
    1.  Добавить в интерфейс фильтр (например, `Tabs` или `Select`) для выбора статуса пользователей (`ALL`, `ACTIVE`, `PLACEHOLDER`).
    2.  При выборе фильтра делать запрос к API с соответствующим параметром `status`.
    3.  Убедиться, что для `PLACEHOLDER` пользователей доступны действия "Редактировать" (для превращения во "взрослого" пользователя) и "Удалить".

---

## 3. Задача: Рефакторинг удаления и версионирования документов

**Цель:** Внедрить "мягкое удаление", прекратить хранение старых PDF, и заложить основу для будущего версионирования.

*Предполагается, что Шаг 0 уже выполнен.*

### Часть A: "Мягкое" удаление (Soft Delete)

#### Шаг 1: Middleware для Prisma
- **Файл:** `src/lib/prisma/middleware.ts` (новый файл)
- **Действия:**
    1.  Создать middleware, которое будет автоматически добавлять условие `deletedAt: null` ко всем `find` операциям для модели `Document`. Это скроет "удаленные" документы из всех обычных выборок.
    2.  Подключить middleware при инициализации клиента Prisma.

#### Шаг 2: Обновление сервисов
- **Файл:** `src/lib/services/DocumentCommandService.ts`
- **Действия:**
    1.  Переименовать существующий метод `deleteDocument` в `hardDeleteDocument` (он будет выполнять `prisma.document.delete`).
    2.  Создать новый метод `softDeleteDocument`, который будет устанавливать `deletedAt: new Date()`.
    3.  В API-роуте для удаления документа вызывать `softDeleteDocument`.

#### Шаг 3: UI для администратора
- **Файл:** `/src/components/documents/admin/AdminDocumentsPage.tsx`
- **Действия:**
    1.  Добавить фильтр для просмотра "удаленных" документов.
    2.  Для удаленных документов отображать кнопку "Восстановить" (вызывает метод, который ставит `deletedAt: null`) и "Удалить навсегда" (вызывает `hardDeleteDocument`).

### Часть B: Очистка старых PDF при обновлении

- **Файл:** `src/lib/services/DocumentCommandService.ts`
- **Действия:**
    1.  В методе `updateDocument`, после успешной загрузки нового файла DOCX и перед обновлением записи в БД, получить путь к старому PDF-файлу.
    2.  Вызвать метод `FileStorageService.deleteFile()` для удаления старого PDF из MinIO.

### Часть C: Будущее версионирование (для `FUTURE_WORK.md`)

- **Концепция:** Отказаться от перезаписи файлов DOCX. Вместо этого, каждое обновление будет создавать новую запись в модели `DocumentVersion`, ссылающуюся на новый файл в хранилище. Основная модель `Document` будет указывать на последнюю актуальную версию. Это позволит в будущем просматривать историю изменений документа.

---

## 4. Задача: Корректировка счетчика просмотров

**Статус:** ✅ **Выполнено.**

**Цель:** Исключить просмотры документов администраторами из публичного счетчика.

- **Файл:** `src/lib/services/DocumentQueryService.ts`
- **Действия:**
    1.  В методе, отвечающем за получение документа для просмотра (вероятно, `getDocumentById`), перед операцией инкремента счетчика (`viewCount`) добавить проверку.
    2.  Получить роль текущего пользователя.
    3.  Если роль пользователя НЕ является `ADMIN`, выполнять инкремент счетчика. Если `ADMIN` — инкремент пропускается.

---

## 5. Задачи из предыдущих планов (на будущее)

**Цель:** Этот раздел содержит актуальные задачи из старых планов, которые предстоит выполнить.

### Улучшение поиска (Эпик 4)
- **Задача:** Улучшить качество поиска для русского языка в FlexSearch.
- **Подзадачи:**
    - [ ] Исследовать и интегрировать библиотеки для стемминга и фонем для русского языка.
    - [ ] Реализовать обработку синонимов и исправление опечаток.

### Новые фичи (Эпик 5)
- [ ] **Система "Секретных" документов:** Завершить реализацию.
- [ ] **Поддержка документов-ссылок:** Реализовать тип документа `REFERENCE`.
- [ ] **Распознавание текста (OCR):** Интегрировать OCR для обработки сканированных PDF.

### Тестирование и Качество Кода
- [ ] **Тестирование FOUC:** Написать E2E тест (Playwright/Cypress) для проверки отсутствия "проблеска" контента.
- [ ] **Unit/Интеграционные тесты:** Настроить Jest и React Testing Library, покрыть тестами сервисы, репозитории и API роуты.

### CI/CD и Инфраструктура
- [ ] **CI/CD:** Создать workflow для GitHub Actions (lint, test, build).
- [ ] **Мониторинг:** Интегрировать `pino` для структурированного логирования и настроить экспорт метрик для Prometheus.

---

## 6. Задачи из `mainProjectSchima.md`

**Цель:** Перенос нереализованных задач из первоначального плана.

- [ ] **Рефакторинг поиска:** Завершить реализацию схемы "сначала фильтры в БД, потом поиск в FlexSearch".
- [ ] **Смена пароля:** Реализовать для пользователя возможность сменить свой пароль на странице профиля.
- [ ] **Страница настроек админ-панели:** Создать страницу `/admin/settings` для управления системными параметрами.
- [ ] **Дашборд админ-панели:** Структурировать и реализовать все необходимые виджеты.
- [ ] **Валидация Zod:** Установить максимальную длину для полей `title`, `description`, `keywords`.
- [ ] **Ограничение по категориям:** Ограничить выбор до 5 категорий на один документ.
- [ ] **Пагинация:** Реализовать пагинацию на основной странице документов.
- [ ] **Счетчики в UI:** Отображать общее количество документов в выбранной категории.
- [ ] **Аудит безопасности:** Провести аудит безопасности загрузки и просмотра файлов.
